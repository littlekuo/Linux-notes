

# 进程调度

## 4.1 多任务
分为非抢占式多任务和抢占式多任务

抢占：由调度程序来决定什么时候停止一个程序的运行  
让步：进程主动挂起自己的操作

## 4.2 Linux的进程调度
2.6.23版本引入了“完全公平调度算法”，叫做CFS

## 4.3 策略
### 4.3.1 IO消耗型和处理器消耗型
调度策略需要在两个目标间寻找平衡：响应时间短和最大系统利用率

### 4.3.2 进程优先级
最基本的就是基于优先级的调度。  
Linux采用了两种不同的优先级范围：
- nice值，范围从-20 到 +19，默认为0，越大的nice值意味着更低的优先级。
- 实时优先级，其值是可以配置的，默认情况下0到99，越高意味着进程优先级越高。
  

### 4.3.3 时间片
时间片：进程被抢占前所能持续运行的时间。  
Linux的CFS调度器并没有直接分配时间片到进程，而是将处理器的使用比划分给了进程。这样一来，进程所获得的处理器时间和负载密切相关。  
Linux中使用的CFS调度器，其抢占时机取决于新的可运行程序消耗了多少处理器使用比，若比当前进程小，则立即投入运行。


## 4.4 Linux调度算法

### 4.4.1 调度器类
Linux调度器是以模块的方式提供的，其目的在于允许不同类型的进程可以有针对性地选择调度算法。  
每个调度器都有一个优先级，基础的调度器代码定义在 kernel/sched.c文件中，它会按照优先级顺序遍历调度类，拥有一个可执行进程的最高优先级的调度器类胜出。
CFS是一个针对普通进程的调度类，在linux中称作SCHED_NORMAL，其实现在kernel/sched_fair.c中。

### 4.4.2 Unix系统中的进程调度
Unix系统上，优先级以nice值形式输出给用户空间，但会带来一些问题。
- 若将nice值映射到时间片，则必然需要将nice值对应到处理器的绝对时间。对于低优先级的进程会带来问题。
- 涉及相对nice值时也会带来问题，比如nice值为0和1对应100ms和95ms，几乎相等，而nice值为18和19对应10ms和5ms, 相差一倍，这并不合理。
- 执行nice值到时间片的映射，需要能分配一个绝对时间片，这个绝对时间片必须在内核的测试范围内，这要求时间片必须是定时器节拍的整数倍。 
 
上述问题中的绝大多数可以通过对传统UNIX调度器进行改造解决，比如
- nice值呈几何增长而非算术增加来解决第二个问题。
- 采用新的度量机制将nice值到时间片的映射与定时器节拍分开，从而解决第三个问题。  

但这些都回避了本质问题，即分配绝对的时间片引发的固定的切换频率，给公平性带来很大变故。
因此 CFS 完全摒弃时间片而是分配给进程一个处理器使用比重，通过这种方式保证恒定的公平性。

### 4.4.3 公平调度
CFS的出发点：进程调度的效果应该如同系统具备一个理想中的完美多任务处理器。在任何可测量的周期内，n个进程的处理器时间都相同。比如
> 假设有两个进程，在标准UNIX调度中，一个先运行5ms，另一个后运行5ms，每一个在运行时都100%占用处理器，而完美的多处理器应该是，10ms内同时运行两个进程，它们各自使用处理器一半的能力。

上述模型并非现实，因为无法在一个处理器真的同时运行多个进程。CFS的做法是：
> 允许每个进程运行一段时间，循环轮转，选择运行最少的进程作为下一个运行进程。CFS在所有可运行进程总数基础上计算出一个进程应该运行多久，nice值在CFS中被作为进程获得的处理器运行比的权重。

每个进程都按照权重在全部可运行进程中所占比例的“时间片”来运行，为了计算准确的时间片，CFS为完美多任务中的无限小调度周期的近似值设立了一个目标，称作“目标延迟(targeted latency)”。例子如下：
> 假设目标延迟值为20ms，如果有4个优先级相同的任务(不管优先级的具体值多少)，则每个运行5ms，如果有20个，则每个1ms。

很容易注意到，当任务数量非常多时，各自获得的运行时间将趋于0，这会带来不可接受的切换开销，CFS 因此引入
> 每个进程获得的时间片底线，这个底线也被称作最小粒度，默认为1ms(在进程数量过多时，CFS实际上无法做到完全公平调度，因为处理器时间无法突破最小粒度，但实际情况下效果还好，因为一般最多只会有几百个进程)

## 4.5 Linux调度的实现
CFS的实现位于 kernel/sched_fair.c 中，重点关注四个部分。

### 4.5.1 时间记账
所有的调度器都必须对进程运行时间做账。
1. 调度器实体结构
CFS需要有时间记账，确保每个进程只在公平分配给它的处理器时间内运行，
CFS使用调度器实体结构来追踪进程进行记账：
```c
struct {
    
}
```











